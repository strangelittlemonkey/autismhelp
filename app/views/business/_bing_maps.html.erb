<script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
<script type="text/javascript">
  function GetMap()
  {
    var myLat = 37.796;   // Default lat, lng
    var myLng = -122.406;
    var orgPinInfobox = null;
    var orgPins = new Microsoft.Maps.EntityCollection();
    var orgPinInfoboxes = new Microsoft.Maps.EntityCollection();
    var options = {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 60000
    };
     
    function success(pos) {
      console.log('GetLocation Success. Map is loading.');
      var crd = pos.coords;
      myLat = crd.latitude;
      myLng = crd.longitude;
      
      loadMap(myLat, myLng);
      //Microsoft.Maps.Events.addHandler(map, 'mouseup', click); 
      //displayAlert('Perform action on map to fire this event')
    };

    function loadMap(lat, lng) {
      var location = new Microsoft.Maps.Location(lat, lng);
      var map = new Microsoft.Maps.Map(document.getElementById('bing_map'), 
        {credentials: 'Av3KxY1c6mhrQ-kkwXXiJLBVEbvUUs-VnYPFtfTGh443r4xyegm7QWbzFILo_mDa',
         center: location,
         mapTypeId: Microsoft.Maps.MapTypeId.road,
         showScalebar: false,
         showDashboard: false,
         zoom: 13});

      var pushpinOptions = {
        icon: '/assets/mylocation.png', 
        width: 48, 
        height: 48, 
        anchor: new Microsoft.Maps.Point(24,24)};
      var pin = new Microsoft.Maps.Pushpin(location, pushpinOptions);
      orgPins.push(pin);

      orgPinInfobox = new Microsoft.Maps.Infobox(new Microsoft.Maps.Location(0,0), { visible: false });
      orgPinInfoboxes.push(orgPinInfobox);

      //displayMap();
      addPins(map, lat, lng);

      map.entities.push(orgPins);
      map.entities.push(orgPinInfoboxes);

      Microsoft.Maps.Events.addHandler(map, 'viewchange', hideInfobox);
    };
     
    function error(err) {
      console.warn('ERROR(' + err.code + '): ' + err.message);
    };

    /*function displayMap() {
      
      
      if (myLat == 37.795 && myLng == -122.408) {
      }
      else {
        map.entities.push(pin);
        map.setView({
          center: location,
          zoom: 16
        });
      }
    };*/

    function addPins(map, lat, lng) {
      var url = 'http://revtilt.com/api/v1/organizations.json?latitude=' + lat + '&longitude=' + lng + '&radius=2'
      $.get(url, function(data) { 
        orgs = data;
        // Get data for each organization
        for(var i=0; i < orgs.organizations.length; i++) {
          var thisOrg = orgs.organizations[i];
          var pinLat = thisOrg.location.latitude;
          var pinLng = thisOrg.location.longitude;
          var pinLocation = new Microsoft.Maps.Location(pinLat, pinLng);
          var orgPin = new Microsoft.Maps.Pushpin(pinLocation);
          orgPin.Url = thisOrg.revtiltUrl;
          orgPin.Title = thisOrg.name;
          orgPin.Description = thisOrg.categoryText;
          /*var orgPage = thisOrg.revtiltApiUrl;
          var orgName = thisOrg.name;
          var orgCategory = thisOrg.categoryText;*/

          /*orgPinInfobox = new Microsoft.Maps.Infobox(orgPin.getLocation(), {
            title: orgName,
            description: 'Category: ' + orgCategory,
            visible: false,
            offset: new Microsoft.Maps.Point(0,15)});*/

          Microsoft.Maps.Events.addHandler(orgPin, 'click', displayInfobox);
          orgPins.push(orgPin);
        }
      })
    }
    
    function displayInfobox(e) {
      orgPinInfobox.setOptions({
        title: e.target.Title,
        description: e.target.Description,
        titleClickHandler: followLink(e.target.Url),
        visible: true,
        offset: new Microsoft.Maps.Point(0,20)});
      orgPinInfobox.setLocation(e.target.getLocation());
    }

    function hideInfobox(e) {
      orgPinInfobox.setOptions({ visible: false });
    }

    function getIdFromApiUrl(url) {
      var getId = new RegExp("[0-9]+");
      id = getId.exec(url)
      console.log('Regex input string : ' + url)
      console.log('Matched Regex :' + id);
      return id[0];
    }

    function followLink(url) {
      id = getIdFromApiUrl(url);
      window.location.href = 'business/show?id=' + id;
    }

    <% if @lat.present? && @lng.present? %>
      console.log("lat, lng present");
      loadMap(<%= @lat %>, <%= @lng %>);
    <% else %>
      navigator.geolocation.getCurrentPosition(success, error, options);
    <% end %>
  }
</script>