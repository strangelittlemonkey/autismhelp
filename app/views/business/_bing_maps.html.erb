<script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
<script type="text/javascript">
  function GetMap()
  {
    var myLat = null;
    var myLng = null;//<%= @lng %>;
    var options = {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    };
     
    function success(pos) {
      var crd = pos.coords;
      myLat = crd.latitude;
      myLng = crd.longitude;
      //alert('success!');
      //alert('' + myLat + ' ' + crd.longitude);
      var location = new Microsoft.Maps.Location(myLat, myLng);
      var map = new Microsoft.Maps.Map(document.getElementById('bing_map'), 
        {credentials: 'Av3KxY1c6mhrQ-kkwXXiJLBVEbvUUs-VnYPFtfTGh443r4xyegm7QWbzFILo_mDa',
         center: location,
         mapTypeId: Microsoft.Maps.MapTypeId.road,
         showScalebar: false,
         showDashboard: false,
         zoom: 14});
      var pushpinOptions = {icon: '/assets/mylocation.png', width: 48, height: 48};
      var pin = new Microsoft.Maps.Pushpin(location, pushpinOptions);

      //displayMap();
      addPins(map, myLat, myLng);

      map.entities.push(pin);

      Microsoft.Maps.Events.addHandler(map, 'click', click); 
      //displayAlert('Perform action on map to fire this event')
    };

    function click() {
      window.location.assign('business/show');
    }
     
    function error(err) {
      console.warn('ERROR(' + err.code + '): ' + err.message);
    };

    /*function displayMap() {
      
      
      if (myLat == 37.795 && myLng == -122.408) {
      }
      else {
        map.entities.push(pin);
        map.setView({
          center: location,
          zoom: 16
        });
      }
    };*/

    function addPins(map, lat, lng) {
      var url = 'http://revtilt.com/api/v1/organizations.json?latitude=' + lat + '&longitude=' + lng + '&radius=2'
      $.get(url, function(data) { 
        orgs = data;
        for(var i=0; i < orgs.organizations.length; i++) {
          var pinLat = orgs.organizations[i].location.latitude;
          var pinLng = orgs.organizations[i].location.longitude;
          var pinLocation = new Microsoft.Maps.Location(pinLat, pinLng);
          
          map.entities.push(new Microsoft.Maps.Pushpin(pinLocation));
        }
      })

    }

    navigator.geolocation.getCurrentPosition(success, error, options);
    //alert('Lat: ' + myLat + ' | Lng: ' + myLng);
    //console.log(getUrlVars());
    
  }
</script>